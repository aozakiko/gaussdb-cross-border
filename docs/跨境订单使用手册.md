# 跨境电商订单监控中心 · 使用手册

## 1. 场景概述

- **定位**：面向跨境电商运营团队，集中监控全球渠道（Amazon、Shopee、Lazada、Shopify、自营站等）的订单履约状态、GMV 与物流进展。
- **技术栈**：GaussDB (openGauss) 负责订单持久化，FastAPI 提供 REST + Jinja2 控制台，原生前端 + Chart.js 构建可视化面板，PySpark 用于批量分析。
- **角色**：
  - 运营/客服：通过前端或后端控制台录入订单、修改状态、查看指标；
  - 数据/运维：使用 Spark/FastAPI API 拉取最新统计，或导入批量测试数据验证能力。

## 2. 环境准备

1. Conda 环境：`conda env create -f environment.yml && conda activate gaussdb-web`
2. 安装依赖：`pip install -r backend/requirements.txt`
3. 确认 `.env` 指向可连接的 GaussDB（建议非初始用户，已配置 md5 认证）。

## 3. 启动步骤

| 步骤 | 命令 | 说明 |
| --- | --- | --- |
| 启动后端 | `cd backend && uvicorn app.main:app --reload` | 同时暴露 REST API (`/records`) 与可视化控制台 (`/`) |
| 启动前端 | `cd frontend && python -m http.server 5173 --bind 127.0.0.1` | 浏览器访问 `http://127.0.0.1:5173`，顶部输入 API 地址 |
| 运行 Spark 分析（可选） | 调用 `GET /records/analytics/spark` 或使用前端按钮 | 若未配置 PySpark，会返回 503 提示 |

> 若使用 Docker，可直接 `docker compose up --build backend frontend`（需要确保 `.env` 中的 GaussDB 地址在容器内可见）。

## 4. 前端操作流程

1. **设置 API 地址**：页面右上角输入 `http://localhost:8000`（或对应公网地址），点击“保存”。
2. **仪表盘**：
   - KPI 卡片展示订单总数 / GMV / 在途 / 异常；
   - 环形图显示履约状态（待履约、拣货中、跨境在途、已签收、异常）。
3. **录入订单**：
   - 填写订单号、渠道、目的国、币种、金额、运单号、履约专员、风险评分、下单时间等；
   - 点击“创建订单”，Toast 会提示是否成功。
4. **列表管理**：
   - 可按履约专员、渠道、目的地、状态过滤；
   - “编辑”进入右侧表单修改，支持部分字段更新；
   - “删除”会弹出确认对话框。
5. **Spark 分析**：点击“运行分布式分析”将触发 `/records/analytics/spark`，结果显示在底部 `<pre>` 中。

## 5. 后端控制台（/）

- 适合在内网调试或无前端部署时使用。
- 顶部 KPI 与图表与前端一致；表单和表格支持快速 CRUD。
- 支持 inline 修改订单状态、删除订单；所有提交都会落到 GaussDB 中，与 REST API 共享数据。

## 6. 批量导入测试数据

1. 生成 CSV：

   ```powershell
   conda activate gaussdb-web
   cd d:/HuaweiMoveData/Users/destiny/Desktop/gaussdb
   python scripts/generate_seed.py
   ```

   输出：`data/orders_seed.csv`（默认 100 条）。

2. 使用 `psql` 导入 GaussDB：

   ```sql
   \copy records(title,description,status,priority,owner,order_number,sales_channel,destination_market,currency,order_amount,tracking_number,order_date)
   FROM 'data/orders_seed.csv' WITH (FORMAT csv, HEADER true, ENCODING 'UTF8');
   ```

3. 刷新前端或后台即可看到数据。可多次运行脚本生成不同数据集（默认会覆盖 CSV）。

## 7. 常用 API

| Method | Path | 描述 |
| --- | --- | --- |
| GET | `/records/?owner=&channel=&destination=&status=` | 支持多条件过滤、分页（`skip` `limit`） |
| POST | `/records/` | 创建订单，需包含 `order_number`、`sales_channel`、`destination_market` 等字段 |
| PUT | `/records/{id}` | 部分/全部更新；当修改 `order_number` 时会校验唯一性 |
| DELETE | `/records/{id}` | 删除订单 |
| GET | `/records/analytics/spark` | 触发 PySpark 汇总（状态/负责人/渠道等统计） |

## 8. 测试 & 诊断

- `conda activate gaussdb-web && cd backend && pytest`
- 若遇到 `psycopg2` 版本兼容问题，确认 `openGauss` 的 `pg_hba.conf`/`postgresql.conf` 已允许 md5 连接，并在 `.env` 使用非初始用户。
- 数据表结构更新后，可执行 `DROP TABLE records;` 再 `Base.metadata.create_all()` 以快速同步；生产环境建议使用 Alembic。